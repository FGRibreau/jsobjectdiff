#!/usr/bin/env node

'use strict';

var jsobjectDiff = require('../');
var _ = require('lodash');
var fs = require('fs');
var path = require('path');
var when = require('when');

var program = require('commander');

var opts = require('nomnom')
  .option('config', {
    abbr: 'c',
    required: true,
    help: 'JSON configuration path'
  })
  .parse();


var FULL_CONFIG_PATH = path.resolve(process.cwd(), opts.config);

when
  .promise(function (resolve, reject) {
    fs.readFile(FULL_CONFIG_PATH, 'utf8', function (err, data) {
      if (err) {
        reject(err);
        return;
      }

      resolve(data);
    });
  })
  .then(function onSuccess(data) {
    when.try(JSON.parse, data).then(function onSuccess(json) {

      var configuration = json.files.map(function (file) {
        var absolutePath = path.resolve(path.dirname(FULL_CONFIG_PATH), file.filePath);
        return {
          objectPath: file.objectPath,
          content: fs.readFileSync(absolutePath).toString('utf8')
        };
      });

      var diff = jsobjectDiff.compare(json.pre, configuration, json.post);

      if (diff.length === 0) {
        process.exit(0);
      }

      console.info('Diff:', JSON.stringify(diff, null, 2));
      process.exit(diff.length);

    }, function onError(err) {
      console.error('Could not parse %s', FULL_CONFIG_PATH);
      console.error(err);
    });
  }, function onError(err) {
    console.error('Could not open %s', FULL_CONFIG_PATH);
    console.error(err);
  });
