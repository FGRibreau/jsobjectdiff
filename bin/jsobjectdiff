#!/usr/bin/env node

'use strict';

var jsobjectDiff = require('../');
var _ = require('lodash');
var fs = require('fs');
var path = require('path');
var when = require('when');
var Table = require('cli-table');

var opts = require('nomnom')
  .option('config', {
    abbr: 'c',
    required: true,
    help: 'JSON configuration path'
  })
  .parse();


var FULL_CONFIG_PATH = path.resolve(process.cwd(), opts.config);

when
  .promise(function(resolve, reject) {
    fs.readFile(FULL_CONFIG_PATH, 'utf8', function(err, data) {
      if (err) {
        reject(err);
        return;
      }

      resolve(data);
    });
  })
  .then(function onSuccess(data) {
    when.try(JSON.parse, data).then(function onSuccess(json) {

      var configuration = json.files.map(function(file) {
        var absolutePath = path.resolve(path.dirname(FULL_CONFIG_PATH), file.filePath);
        return {
          filePath: file.filePath,
          objectPath: file.objectPath,
          content: fs.readFileSync(absolutePath).toString('utf8')
        };
      });

      var diff = jsobjectDiff.compare(json.pre, configuration, json.post);

      if (diff.length === 0) {
        process.exit(0);
      }
      var table = new Table();
      diff.map(function(objectFiles) {
        objectFiles.comparedTo.map(function(comparaison) {
          comparaison.inPlus.map(function(keyAndIndex) {
            var content = fs.readFileSync(path.resolve(path.dirname(FULL_CONFIG_PATH), objectFiles.filePath)).toString('utf8');
            var line = _.findIndex(content.split('\n'), function(line) {
              return line.indexOf(keyAndIndex.key) !== -1;
            });
            var key = keyAndIndex.key;
            var filePath = comparaison.filePath;
            var objectPath = comparaison.objectPath;
            table.push(['+ ' + key + ' to the line ' + line + ' of ' + filePath + ' ' + objectPath]);
          });
          comparaison.inLess.map(function(keyAndIndex) {
            var content = fs.readFileSync(path.resolve(path.dirname(FULL_CONFIG_PATH), comparaison.filePath)).toString('utf8');
            var line = _.findIndex(content.split('\n'), function(line) {
              return line.indexOf(keyAndIndex.key) !== -1;
            });
            var key = keyAndIndex.key;
            var filePath = objectFiles.filePath;
            var objectPath = objectFiles.objectPath;
            table.push(['- ' + key + ' to the line ' + line + ' of ' + filePath + ' ' + objectPath]);
          });
        })
      })
      console.log(table.toString());
      process.exit(diff.length);

    }, function onError(err) {
      console.error('Could not parse %s', FULL_CONFIG_PATH);
      console.error(err);
    });
  }, function onError(err) {
    console.error('Could not open %s', FULL_CONFIG_PATH);
    console.error(err);
  });