#!/usr/bin/env node

var jsobjectDiff = require('../');
var _            = require('lodash');
var fs           = require('fs');

var json = {};

json = JSON.parse(fs.readFileSync('../config.json', 'utf8'));

if(!json.files){
  json.files = [];
}

function collect(val, memo) {
  memo.push(val);
  return memo;
}

process.argv.forEach(function(val, index, array) {
  if (val == '--pre') {
    json.pre = '(function (Bringr) {';
  }

  if (val == '--post') {
    json.post = 'return Bringr;})({});'
  }

  if (val == '--file1') {
    json.files[0] = JSON.parse(array[++index]);
  }

  if (val == '--file2') {
    json.files[1] = JSON.parse(array[++index]);
  }

  if (val == '--save') {
    fs.writeFileSync('../config.json', JSON.stringify(json, null, 2));
  }
});

if (!json.files || !Array.isArray(json.files) || json.files.length !== 2) {
  console.log('files should be defined');
  process.exit(1);
}

var filesWithExtract = json.files.map(function(fileTab) {
  return {
    filepath: fileTab[0],
    objectpath: fileTab[1].split('.'),
    extract: function(object) {
      function findObject(object, path, i) {
        if (i < path.length - 1) {
          return findObject(object[path[i]], path, ++i);
        }
        return object[path[i]];
      }
      return findObject(object,this.objectpath, 0);
    }
  };
});

var diff = jsobjectDiff.compare(json.pre, filesWithExtract, json.post);
if (diff.length === 0) {
  process.exit(0);
}

console.log('Diff : ');
console.log(JSON.stringify(diff, null, 2));
process.exit(diff.length);